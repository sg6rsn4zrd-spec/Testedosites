<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>LISBOA PRO MASTER</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
:root {
    --bg: #0a0e17; --card: #161b28; --primary: #2a5ee8;
    --accent: #00d2ff; --success: #00f298; --danger: #ff4b5c;
    --text: #e1e8f0;
}
body {
    margin: 0; font-family: 'Inter', sans-serif;
    background: var(--bg); color: var(--text);
    padding-bottom: 80px;
}

/* Cabe√ßalho */
.header {
    background: var(--card); padding: 20px; text-align: center;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}
.header img { max-width: 130px; }

/* Container */
.container { padding: 15px; max-width: 600px; margin: auto; }

/* Cart√£o de saldo */
.balance-card {
    background: linear-gradient(135deg, #1e2a4a, #161b28);
    padding: 25px; border-radius: 24px;
    text-align: center; margin-bottom: 20px;
    border: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}
.balance-card h2 { margin: 0; font-size: 0.8rem; text-transform: uppercase; opacity:0.7; }
.balance-val { font-size: 2.5rem; font-weight: 800; color: var(--success); margin: 10px 0; }

/* Menu Grid */
.menu-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 25px; }
.menu-item {
    background: var(--card); padding: 12px 5px;
    border-radius: 16px; text-align: center;
    border: 1px solid rgba(255,255,255,0.05);
    cursor: pointer; transition: 0.2s;
}
.menu-item i { font-size: 1.2rem; color: var(--accent); margin-bottom: 6px; display:block; }
.menu-item span { font-size: 0.55rem; font-weight:700; text-transform: uppercase; }
.menu-item:active { transform: scale(0.9); background: var(--primary); }

/* Se√ß√µes */
.section { background: var(--card); padding: 20px; border-radius:24px; display:none; border:1px solid rgba(255,255,255,0.05); }
.active { display:block; animation: slideIn 0.3s ease-out; }
@keyframes slideIn { from { opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

/* Inputs e Bot√µes */
input, select, textarea {
    background:#0f141e; border:1px solid #2d364a;
    color:white; padding:14px; border-radius:12px;
    width:100%; box-sizing:border-box; margin:8px 0; font-size:15px;
}
button {
    background:var(--primary); color:white;
    padding:16px; border-radius:14px; border:none;
    font-weight:700; width:100%; cursor:pointer;
    margin-top:10px; font-size:14px; transition:0.2s;
}
button:active{opacity:0.8;}
.btn-success{background:var(--success); color:#0a0e17;}
.btn-danger{background:var(--danger);}

/* Listas */
.list-item {
    background: rgba(255,255,255,0.03); padding:15px;
    border-radius:16px; margin-bottom:10px;
    display:flex; justify-content:space-between; align-items:center;
    border-left:4px solid var(--primary);
}
.badge {
    background: var(--danger); color:white;
    border-radius:50px; padding:2px 8px; font-size:10px;
    position:absolute; top:-5px; right:-5px;
}

/* IA Box */
.ia-box {
    background:#000; border:1px solid var(--success);
    padding:15px; border-radius:12px;
    font-family:'Courier New', monospace;
    color:var(--success); font-size:13px; line-height:1.4;
}
</style>
</head>
<body>

<div class="header">
    <img src="B1BCC237-7C89-4142-8131-6DA05C2A2C61 2.png" alt="Lisboa Pro Master">
</div>

<div id="loginPage" class="container">
    <div class="balance-card">
        <i class="fas fa-shield-alt" style="font-size:2rem; color:var(--accent)"></i>
        <h3>ACESSO RESTRITO</h3>
        <input id="pass" type="password" placeholder="Senha Administrativa">
        <button onclick="login()">ENTRAR NO PAINEL</button>
    </div>
</div>

<div id="mainPage" class="container" style="display:none">
    <div class="balance-card">
        <h2>Saldo Real (LUCRO LIMPO)</h2>
        <div class="balance-val" id="val-lucro">R$ 0,00</div>
        <div style="display:flex; justify-content:space-around; opacity:0.8; font-size:12px;">
            <span>M√£o de Obra: <b id="val-mao" style="color:var(--accent)">R$ 0</b></span>
            <span>Contas: <b id="val-contas" style="color:var(--danger)">R$ 0</b></span>
            <span>Pe√ßas: <b id="val-pecas" style="color:var(--primary)">R$ 0</b></span>
        </div>
    </div>

    <div class="menu-grid">
        <div class="menu-item" onclick="nav('sec-dash')"><i class="fas fa-chart-line"></i><span>Dash</span></div>
        <div class="menu-item" onclick="nav('sec-serv')"><i class="fas fa-plus"></i><span>Novo</span></div>
        <div class="menu-item" onclick="nav('sec-contas')"><i class="fas fa-receipt"></i><span>Contas</span></div>
        <div class="menu-item" onclick="nav('sec-hist')"><i class="fas fa-search"></i><span>Busca</span></div>
        <div class="menu-item" onclick="nav('sec-oleo')" style="position:relative">
            <i class="fas fa-oil-can"></i><span>√ìleo</span>
            <span id="notif-oleo" class="badge" style="display:none">0</span>
        </div>
        <div class="menu-item" onclick="nav('sec-estoque')"><i class="fas fa-box"></i><span>Estoque</span></div>
        <div class="menu-item" onclick="nav('sec-tabela')"><i class="fas fa-tags"></i><span>Tabela</span></div>
        <div class="menu-item" onclick="nav('sec-taxa')"><i class="fas fa-credit-card"></i><span>Taxas</span></div>
        <div class="menu-item" onclick="nav('sec-agenda')"><i class="fas fa-calendar"></i><span>Agenda</span></div>
        <div class="menu-item" onclick="nav('sec-compras')"><i class="fas fa-cart-plus"></i><span>Compras</span></div>
        <div class="menu-item" onclick="nav('sec-check')"><i class="fas fa-clipboard-list"></i><span>Check</span></div>
        <div class="menu-item" onclick="nav('sec-ia')"><i class="fas fa-brain"></i><span>I.A</span></div>
    </div>
<!-- DASHBOARD FINANCEIRO -->
<div id="sec-dash" class="section active">
    <h3>üìä Resumo Financeiro</h3>
    <canvas id="chartFin" height="200"></canvas>
    <div>
        <label for="metaLucro">Meta de Lucro R$:</label>
        <input id="metaLucro" type="number" placeholder="Ex: 5000">
        <label for="metaServ">Meta de Servi√ßos:</label>
        <input id="metaServ" type="number" placeholder="Ex: 30">
        <label for="metaPecas">Meta de Pe√ßas R$:</label>
        <input id="metaPecas" type="number" placeholder="Ex: 2000">
        <button class="btn-success" onclick="renderDashboardMetas()">Atualizar Metas</button>
    </div>
    <button class="btn-success" onclick="gerarPDF()">GERAR RELAT√ìRIO PDF</button>
    <button class="btn-success" onclick="exportCSV()">EXPORTAR CSV/EXCEL</button>
    <button class="btn-danger" onclick="resetMes()">ZERAR DADOS DO M√äS</button>
</div>

<!-- NOVO SERVI√áO -->
<div id="sec-serv" class="section">
    <h3>üîß Novo Servi√ßo</h3>
    <input id="sNome" placeholder="Nome do Cliente">
    <input id="sPlaca" placeholder="Placa">
    <input id="sCel" placeholder="Celular (WhatsApp)">
    <input id="sMao" type="number" placeholder="M√£o de Obra (Seu Ganho)">
    <input id="sPec" type="number" placeholder="Pe√ßas (Custo Reposi√ß√£o)">
    <select id="sOleo">
        <option value="nao">Troca de √ìleo? N√£o</option>
        <option value="sim">Troca de √ìleo? Sim (Lembrar em 90 dias)</option>
    </select>
    <button class="btn-success" onclick="salvarServico()">SALVAR SERVI√áO</button>
    <button onclick="zapOrcamento()">ENVIAR OR√áAMENTO (WhatsApp)</button>
</div>

<!-- CONTAS E DESPESAS -->
<div id="sec-contas" class="section">
    <h3>üí∏ Contas e Despesas</h3>
    <input id="cDesc" placeholder="Ex: Luz, Aluguel, Almo√ßo">
    <input id="cVal" type="number" placeholder="Valor R$">
    <input id="cData" type="date">
    <select id="cTipo">
        <option value="pix">PIX</option>
        <option value="dinheiro">Dinheiro</option>
        <option value="debito">Cart√£o D√©bito</option>
        <option value="credito">Cart√£o Cr√©dito</option>
    </select>
    <button class="btn-danger" onclick="salvarConta()">PAGAR CONTA</button>
    <div>
        <label>Filtrar Contas:</label>
        <input id="filtroContas" placeholder="Ex: acima de R$ 100" onkeyup="render()">
    </div>
    <div id="lista-contas"></div>
</div>

<!-- HIST√ìRICO -->
<div id="sec-hist" class="section">
    <h3>üìÇ Hist√≥rico de Servi√ßos</h3>
    <input id="busca" placeholder="Buscar por placa, cliente..." onkeyup="render()">
    <div>
        <label>Filtrar por valor m√≠nimo:</label>
        <input id="filtroLucro" type="number" placeholder="Ex: 200" onkeyup="render()">
    </div>
    <div id="lista-hist"></div>
</div>

<!-- LEMBRETE DE √ìLEO -->
<div id="sec-oleo" class="section">
    <h3>üõ¢Ô∏è Lembrete de √ìleo</h3>
    <div id="lista-oleo"></div>
</div>

<!-- ESTOQUE INTELIGENTE -->
<div id="sec-estoque" class="section">
    <h3>üì¶ Estoque</h3>
    <input id="eN" placeholder="Pe√ßa">
    <input id="eQ" type="number" placeholder="Quantidade">
    <button onclick="addObj('estoque','eN','eQ')">ADICIONAR</button>
    <label>Alerta m√≠nimo:</label>
    <input id="estoqueAlerta" type="number" placeholder="Ex: 5" onkeyup="render()">
    <div id="l-estoque"></div>
</div>

<!-- TABELA DE PRE√áOS -->
<div id="sec-tabela" class="section">
    <h3>üìã Tabela de Pre√ßos</h3>
    <input id="tN" placeholder="Servi√ßo">
    <input id="tV" placeholder="Valor">
    <button onclick="addObj('tabela','tN','tV')">ADICIONAR</button>
    <div id="l-tabela"></div>
</div>

<!-- CALCULADORA DE TAXAS -->
<div id="sec-taxa" class="section">
    <h3>üí≥ Calculadora de Taxas</h3>
    <input id="taxV" type="number" placeholder="Valor do Servi√ßo">
    <select id="taxTipo">
        <option value="credito">Cart√£o Cr√©dito (+12%)</option>
        <option value="debito">Cart√£o D√©bito (+4%)</option>
        <option value="pix">PIX/Dinheiro (0%)</option>
    </select>
    <button onclick="calcTaxa()">CALCULAR</button>
</div>

<!-- AGENDA COMPLETA -->
<div id="sec-agenda" class="section">
    <h3>üìÖ Agenda de Retorno</h3>
    <input id="aN" placeholder="Cliente">
    <input id="aD" type="date">
    <button onclick="addObj('agenda','aN','aD')">AGENDAR</button>
    <div id="l-agenda"></div>
</div>

<!-- LISTA DE COMPRAS -->
<div id="sec-compras" class="section">
    <h3>üõí Lista de Compras</h3>
    <input id="cpN" placeholder="Item faltando">
    <button onclick="addObj('compras','cpN')">ADICIONAR</button>
    <div id="l-compras"></div>
</div>

<!-- CHECK-LIST -->
<div id="sec-check" class="section">
    <h3>üìã Check-list Entrada</h3>
    <input id="chP" placeholder="Placa">
    <textarea id="chD" placeholder="Observa√ß√µes/Avarias"></textarea>
    <button onclick="addObj('check','chP','chD')">SALVAR</button>
    <div id="l-check"></div>
</div>

<!-- I.A ANALISTA + BACKUP -->
<div id="sec-ia" class="section">
    <h3>ü§ñ Analista Inteligente</h3>
    <div id="ia-res" class="ia-box">Aguardando dados...</div>
    <button onclick="analisarIA()">GERAR DIAGN√ìSTICO</button>
    <hr style="opacity:0.1; margin:20px 0">
    <button onclick="gerarBackup()" style="background:#333">GERAR BACKUP</button>
    <textarea id="txtBack" style="font-size:8px"></textarea>
</div>
<script>
/********** BANCO DE DADOS CENTRAL **********/
let db = JSON.parse(localStorage.getItem('lisboa_master')) || {
    mao:0, contas:0, pecas:0,
    servicos:[], despesas:[], estoque:[], tabela:[],
    agenda:[], compras:[], check:[]
};
let chart;

/********** LOGIN **********/
const loginPage = document.getElementById('loginPage');
const mainPage = document.getElementById('mainPage');
function login(){
    if(document.getElementById('pass').value === '1234'){
        loginPage.style.display='none';
        mainPage.style.display='block';
        render();
    } else { alert('Senha incorreta!'); }
}

/********** NAVEGA√á√ÉO **********/
function nav(id){
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

/********** FUN√á√ïES DE CADASTRO **********/
function salvarServico(){
    let m = parseFloat(sMao.value)||0;
    let p = parseFloat(sPec.value)||0;
    if(m+p>0){
        db.mao += m; db.pecas += p;
        db.servicos.unshift({
            n:sNome.value,
            p:sPlaca.value.toUpperCase(),
            v:(m+p),
            m:m, pe:p,
            z:sCel.value,
            ol:sOleo.value,
            d:new Date().getTime()
        });
        sMao.value=''; sPec.value=''; sNome.value=''; sPlaca.value=''; sCel.value='';
        save();
        alert("‚úÖ Servi√ßo salvo!");
    }
}

function salvarConta(){
    let v=parseFloat(cVal.value)||0;
    if(v>0){
        db.contas += v;
        db.despesas.unshift({
            n:cDesc.value,
            v:v,
            tipo: cTipo.value,
            d:cData.value || new Date().toLocaleDateString()
        });
        cVal.value=''; cDesc.value=''; save();
    }
}

/********** FUN√á√ÉO GEN√âRICA ADD **********/
function addObj(t,id1,id2){
    let obj = { n: document.getElementById(id1).value };
    if(id2) obj.v = document.getElementById(id2).value;
    db[t].push(obj);
    document.getElementById(id1).value='';
    if(id2) document.getElementById(id2).value='';
    save();
}

/********** RENDERIZA√á√ÉO E ALERTAS **********/
function render(){
    // SALDO
    let lucro = db.mao-db.contas;
    document.getElementById('val-lucro').innerText = "R$ "+lucro.toFixed(2);
    document.getElementById('val-mao').innerText = "R$ "+db.mao.toFixed(2);
    document.getElementById('val-contas').innerText = "R$ "+db.contas.toFixed(2);
    document.getElementById('val-pecas').innerText = "R$ "+db.pecas.toFixed(2);

    // HIST√ìRICO FILTRADO
    let filtroPlaca = (busca.value||"").toUpperCase();
    let filtroLucro = parseFloat(document.getElementById('filtroLucro')?.value) || 0;
    document.getElementById('lista-hist').innerHTML =
        db.servicos
        .filter(s=>s.p.includes(filtroPlaca) && s.v>=filtroLucro)
        .map(s=>`<div class="list-item"><span><b>${s.p}</b> - ${s.n}</span><b>R$ ${s.v}</b></div>`).join('');

    // CONTAS FILTRADAS
    let filtroConta = parseFloat(document.getElementById('filtroContas')?.value) || 0;
    document.getElementById('lista-contas').innerHTML =
        db.despesas
        .filter(d=>d.v>=filtroConta)
        .map(d=>`<div class="list-item"><span>${d.n} (${d.tipo})</span><b style="color:red">- R$ ${d.v}</b></div>`).join('');

    // √ìLEO VENCIDO (Notifica√ß√£o Autom√°tica)
    let hoje = new Date().getTime();
    let vencidos=0;
    let htmlOleo="";
    db.servicos.forEach(s=>{
        if(s.ol==='sim'){
            let dias = Math.floor((hoje-s.d)/(1000*60*60*24));
            if(dias>=90){
                vencidos++;
                htmlOleo+=`<div class="list-item" style="border-left-color:red">
                <span>${s.p} - ${s.n} (${dias} dias)</span>
                <i class="fab fa-whatsapp" onclick="window.open('https://api.whatsapp.com/send?phone=${s.z}&text=Ol√°! J√° faz 3 meses da √∫ltima troca de √≥leo. Vamos agendar?')"></i>
                </div>`;
            }
        }
    });
    document.getElementById('notif-oleo').innerText=vencidos;
    document.getElementById('notif-oleo').style.display=vencidos>0?'block':'none';
    document.getElementById('lista-oleo').innerHTML = htmlOleo||"Sem trocas pendentes.";

    // ESTOQUE ALERTA
    let minEstoque = parseInt(document.getElementById('estoqueAlerta')?.value)||5;
    let htmlEst="";
    db.estoque.forEach(e=>{
        let cor = (parseInt(e.v) || 0) < minEstoque ? 'red':'';
        htmlEst+=`<div class="list-item" style="border-left-color:${cor||'#00d2ff'}">
            <span>${e.n}</span><b>${e.v||0}</b></div>`;
    });
    document.getElementById('l-estoque').innerHTML = htmlEst||"Estoque vazio.";

    // GR√ÅFICO LUCRO
    const ctx = document.getElementById('chartFin').getContext('2d');
    if(chart) chart.destroy();
    chart=new Chart(ctx,{
        type:'doughnut',
        data:{
            labels:['Lucro Limpo','Contas','Pe√ßas'],
            datasets:[{
                data:[lucro>0?lucro:0,db.contas,db.pecas],
                backgroundColor:['#00f298','#ff4b5c','#00d2ff'],borderWidth:0
            }]
        },
        options:{plugins:{legend:{labels:{color:'white'}}}}
    });

    renderDashboardMetas(); // Atualiza metas
}

/********** I.A ANALISTA **********/
function analisarIA(){
    let lucro = db.mao-db.contas;
    let analise="";
    if(lucro<=0) analise="> ALERTA CR√çTICO: Contas superam o lucro!";
    else if(db.contas>db.mao*0.5) analise="> CUIDADO: Despesas >50% do lucro.";
    else analise="> SA√öDE √ìTIMA: Lucro saud√°vel. R$ "+lucro.toFixed(2);
    document.getElementById('ia-res').innerText=analise+"\n\n> DICA: "+(db.servicos.length<5?"Cadastre mais servi√ßos para an√°lise precisa":"Aproveite a lista de √≥leo para atrair clientes antigos.");
}

/********** WHATSAPP OR√áAMENTO **********/
function zapOrcamento(){
    let total = parseFloat(sMao.value)+parseFloat(sPec.value);
    window.open(`https://api.whatsapp.com/send?phone=${sCel.value}&text=Ol√°! Or√ßamento Lisboa: M√£o de Obra R$ ${sMao.value}, Pe√ßas R$ ${sPec.value}. Total R$ ${total}`);
}

/********** PDF **********/
function gerarPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("Relat√≥rio Lisboa Master PRO",10,10);
    doc.text(`Lucro: R$ ${db.mao - db.contas}`,10,20);
    doc.save("relatorio.pdf");
}

/********** CSV/EXCEL **********/
function exportCSV(){
    let csv = "Se√ß√£o,Nome,Valor,Data,Tipo\n";
    db.servicos.forEach(s=>csv+=`Servi√ßo,${s.n},${s.v},${new Date(s.d).toLocaleDateString()},M√£o:${s.m} Pe√ßas:${s.pe}\n`);
    db.despesas.forEach(d=>csv+=`Despesa,${d.n},${d.v},${d.d},${d.tipo}\n`);
    db.estoque.forEach(e=>csv+=`Estoque,${e.n},${e.v},-,-\n`);
    let blob = new Blob([csv],{type:'text/csv'});
    let url = URL.createObjectURL(blob);
    let a=document.createElement('a'); a.href=url; a.download="export.csv"; a.click();
    URL.revokeObjectURL(url);
}

/********** TAXA **********/
function calcTaxa(){
    let valor=parseFloat(taxV.value)||0;
    let tipo=taxTipo.value;
    let total=valor;
    if(tipo==='credito') total=valor*1.12;
    else if(tipo==='debito') total=valor*1.04;
    alert("Para receber R$ "+valor.toFixed(2)+", cobre R$ "+total.toFixed(2));
}

/********** RESET M√äS **********/
function resetMes(){
    if(confirm("Deseja zerar os ganhos do m√™s?")){ db.mao=0; db.contas=0; db.pecas=0; save(); }
}

/********** BACKUP AUTOM√ÅTICO **********/
function gerarBackup(){ txtBack.value=btoa(JSON.stringify(db)); }

/********** DASHBOARD METAS **********/
function renderDashboardMetas(){
    let metaL = parseFloat(document.getElementById('metaLucro')?.value)||0;
    let metaS = parseFloat(document.getElementById('metaServ')?.value)||0;
    let metaP = parseFloat(document.getElementById('metaPecas')?.value)||0;

    if(metaL>0){
        let perc = Math.min((db.mao-db.contas)/metaL*100,100);
        console.log("Meta Lucro: "+perc.toFixed(1)+"%");
    }
    if(metaS>0){
        let perc = Math.min(db.servicos.length/metaS*100,100);
        console.log("Meta Servi√ßos: "+perc.toFixed(1)+"%");
    }
    if(metaP>0){
        let perc = Math.min(db.pecas/metaP*100,100);
        console.log("Meta Pe√ßas: "+perc.toFixed(1)+"%");
    }
}

/********** SALVAR NO LOCALSTORAGE **********/
function save(){ localStorage.setItem('lisboa_master',JSON.stringify(db)); render(); }

/********** INICIALIZA√á√ÉO **********/
render();
</script>
</body>
</html>
